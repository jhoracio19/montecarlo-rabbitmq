<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Dashboard Montecarlo</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background: #f5f6fa; }
        .card { @apply bg-white rounded-xl shadow p-6; }
        .title { @apply text-xl font-semibold mb-3; }
    </style>
</head>

<body class="text-gray-800">

<header class="bg-white shadow px-8 py-6">
    <h1 class="text-3xl font-bold flex items-center gap-3">ðŸ“Š Dashboard Montecarlo</h1>
    <p class="text-gray-500 mt-1">Monitor en tiempo real de simulaciones</p>
</header>

<main class="p-8 space-y-10">

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <div class="card">
            <p class="text-gray-500 text-sm">Total de Simulaciones</p>
            <p id="kpi_total" class="text-3xl font-bold mt-2">...</p>
        </div>

        <div class="card">
            <p class="text-gray-500 text-sm">Costo Promedio Final</p>
            <p id="kpi_costo" class="text-3xl font-bold mt-2">...</p>
        </div>

        <div class="card">
            <p class="text-gray-500 text-sm">Riesgo Promedio</p>
            <p id="kpi_riesgo" class="text-3xl font-bold mt-2">...</p>
        </div>

    </div>

    <!-- GrÃ¡ficas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <div class="card">
            <h2 class="title">DistribuciÃ³n del Costo Total</h2>
            <canvas id="chartCostos" height="140"></canvas>
        </div>

        <div class="card">
            <h2 class="title">Riesgos Observados</h2>
            <canvas id="chartRiesgo" height="140"></canvas>
        </div>

    </div>

    <!-- Tablas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <div class="card">
            <h2 class="title">âœ… Resultados Recientes</h2>
            <div id="recentResults" class="max-h-80 overflow-y-auto text-sm">Cargando...</div>
        </div>

        <div class="card">
            <h2 class="title">ðŸ“ˆ Resultados Finales</h2>
            <div id="finalResults" class="max-h-80 overflow-y-auto text-sm">Cargando...</div>
        </div>

    </div>

    <div class="text-center mt-10">
        <button onclick="loadDashboard()" class="bg-blue-600 text-white px-6 py-3 rounded-xl text-lg shadow">
            ðŸ”„ Actualizar
        </button>
    </div>

</main>

<script>

let chartCosto, chartRiesgo;

async function loadDashboard() {

    // fetch data
    const recent = await (await fetch("/results?limit=50")).json();
    const finals = await (await fetch("/results/finales?limit=50")).json();

    // KPIs
    document.getElementById("kpi_total").innerText = recent.length;
    document.getElementById("kpi_costo").innerText =
        finals.length ? finals[0].costo_promedio.toFixed(2) : "...";
    document.getElementById("kpi_riesgo").innerText =
        finals.length ? finals[0].riesgo_promedio.toFixed(3) : "...";

    // Recent table
    document.getElementById("recentResults").innerHTML = recent.map(x => `
        <div class='border-b py-2'>
            <strong>ID:</strong> ${x.id} â€”
            Tiempo: ${x.tiempo}h â€”
            Costo: $${x.costo_total.toFixed(2)}
        </div>`).join("");

    // Final table
    document.getElementById("finalResults").innerHTML = finals.map(x => `
        <div class='border-b py-2'>
            <strong>ID:</strong> ${x.id} â€”
            Tiempo prom: ${x.tiempo_promedio.toFixed(2)} â€”
            Costo prom: $${x.costo_promedio.toFixed(2)} â€”
            Riesgo prom: ${x.riesgo_promedio.toFixed(3)}
        </div>`).join("");

    renderCharts(recent);
}

function renderCharts(data) {
    const costos = data.map(x => x.costo_total);
    const riesgos = data.map(x => x.riesgo);

    if (chartCosto) chartCosto.destroy();
    chartCosto = new Chart(document.getElementById("chartCostos"), {
        type: "bar",
        data: {
            labels: costos.map((_, i) => `Sim ${i+1}`),
            datasets: [{ label: "Costo Total", data: costos }]
        }
    });

    if (chartRiesgo) chartRiesgo.destroy();
    chartRiesgo = new Chart(document.getElementById("chartRiesgo"), {
        type: "line",
        data: {
            labels: riesgos.map((_, i) => `Sim ${i+1}`),
            datasets: [{ label: "Riesgo", data: riesgos }]
        }
    });
}

loadDashboard();
setInterval(loadDashboard, 10000);

</script>

</body>
</html>
